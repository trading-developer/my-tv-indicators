//@version=5
indicator("VSA Signal Strength Clean [Alex Ko]", overlay=false)

len = input.int(10, title="ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°")
smooth = input.int(3, title="Ğ¡Ğ³Ğ»Ğ°Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°")

spread = high - low
spread_avg = ta.sma(spread, len)
vol_avg = ta.sma(volume, len)
close_rel = (close - low) / math.max(spread, 0.00001)

signal = 0.0

// === VSA Conditions ===
nd = close > open and volume < vol_avg * 0.7 and spread < spread_avg and close_rel > 0.7
ut = close < open and volume > vol_avg * 1.2 and spread > spread_avg and close_rel < 0.3
ns = close < open and volume < vol_avg * 0.7 and spread < spread_avg and close_rel < 0.3
sv = close < open and volume > vol_avg * 1.5 and close_rel > 0.5
bc = close > open and volume > vol_avg * 2 and spread > spread_avg and close_rel < 0.5
sc = close < open and volume > vol_avg * 2 and spread > spread_avg and close_rel > 0.5

signal := nd or ut or bc ? -1 : signal
signal := ns or sv or sc ? 1 : signal

vsa_line = ta.sma(signal, smooth)
plot(vsa_line, title="VSA Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»", color=color.orange, linewidth=2)
hline(0, "0", color=color.gray)

// === ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ (Ğ¾Ğ´Ğ½Ğ° Ğ½Ğ° Ğ±Ğ°Ñ€) ===
plotshape(nd, title="ND", location=location.abovebar, text="ND (Ğ½ĞµÑ‚ ÑĞ¿Ñ€Ğ¾ÑĞ°)", style=shape.labeldown, color=color.red, textcolor=color.white, size=size.tiny)
plotshape(ut, title="UT", location=location.abovebar, text="UT (Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ¹ Ğ²Ğ²ĞµÑ€Ñ… (ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ))", style=shape.labeldown, color=color.red, textcolor=color.white, size=size.tiny)
plotshape(ns, title="NS", location=location.belowbar, text="NS (Ğ½ĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)", style=shape.labelup, color=color.green, textcolor=color.white, size=size.tiny)
plotshape(sv, title="SV", location=location.belowbar, text="SV (Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğ°)", style=shape.labelup, color=color.green, textcolor=color.white, size=size.tiny)
plotshape(bc, title="BC", location=location.abovebar, text="BC (ĞºÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº)", style=shape.labeldown, color=color.red, textcolor=color.white, size=size.tiny)
plotshape(sc, title="SC", location=location.belowbar, text="SC (ĞºÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶)", style=shape.labelup, color=color.green, textcolor=color.white, size=size.tiny)

// === Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¼ 3 Ğ±Ğ°Ñ€Ğ°Ğ¼ ===
s1 = vsa_line
s2 = vsa_line[1]
s3 = vsa_line[2]
recommend = s1 + s2 + s3

text_out = recommend >= 2 ? "ĞŸĞĞšĞ£ĞŸĞĞ¢Ğ¬ ğŸŸ¢" : recommend <= -2 ? "ĞŸĞ ĞĞ”ĞĞ’ĞĞ¢Ğ¬ ğŸ”´" : "Ğ–Ğ”ĞĞ¢Ğ¬ âšª"

label.new(bar_index, vsa_line, text_out,
     xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_left,
     color=color.gray, textcolor=color.white, size=size.normal, tooltip="Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ VSA")


// === Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ VSA ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² (Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸)
var table vsaTable = table.new(position.top_right, 2, 7, border_width=1)

if bar_index % 20 == 0  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ½Ğµ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ±Ğ°Ñ€Ğµ
    table.cell(vsaTable, 0, 0, "Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(vsaTable, 1, 0, "Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ", text_color=color.white, bgcolor=color.gray, text_size=size.small)

    table.cell(vsaTable, 0, 1, "ND", text_color=color.red)
    table.cell(vsaTable, 1, 1, "ĞĞµÑ‚ ÑĞ¿Ñ€Ğ¾ÑĞ° (ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ)", text_color=color.red)

    table.cell(vsaTable, 0, 2, "UT", text_color=color.red)
    table.cell(vsaTable, 1, 2, "ĞĞ¿-Ñ‚Ñ€Ğ°ÑÑ‚ (Ğ»Ğ¾Ğ²ÑƒÑˆĞºĞ° Ğ²Ğ²ĞµÑ€Ñ…)", text_color=color.red)

    table.cell(vsaTable, 0, 3, "BC", text_color=color.red)
    table.cell(vsaTable, 1, 3, "ĞšÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº", text_color=color.red)

    table.cell(vsaTable, 0, 4, "NS", text_color=color.green)
    table.cell(vsaTable, 1, 4, "ĞĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (ÑĞ¸Ğ»Ğ°)", text_color=color.green)

    table.cell(vsaTable, 0, 5, "SV", text_color=color.green)
    table.cell(vsaTable, 1, 5, "ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğ°", text_color=color.green)

    table.cell(vsaTable, 0, 6, "SC", text_color=color.green)
    table.cell(vsaTable, 1, 6, "ĞšÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶", text_color=color.green)

// === Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°
var table liveTable = table.new(position.bottom_right, 2, 3, border_width=1)

// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°
lastSignal = nd ? "ND" :
             ut ? "UT" :
             bc ? "BC" :
             ns ? "NS" :
             sv ? "SV" :
             sc ? "SC" : "â€”"

// Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸
lastDesc = nd ? "ĞĞµÑ‚ ÑĞ¿Ñ€Ğ¾ÑĞ° (ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ)" : ut ? "ĞĞ¿-Ñ‚Ñ€Ğ°ÑÑ‚ (Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ¹)" : bc ? "ĞšÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº" : ns ? "ĞĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (ÑĞ¸Ğ»Ğ°)" : sv ? "ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğ°" : sc ? "ĞšÑƒĞ»ÑŒĞ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶" : "ĞĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°"

// Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ (Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… 3 ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²)
r = s1 + s2 + s3
recommend_text = r >= 2 ? "ĞŸĞĞšĞ£ĞŸĞĞ¢Ğ¬ ğŸŸ¢" :
                 r <= -2 ? "ĞŸĞ ĞĞ”ĞĞ’ĞĞ¢Ğ¬ ğŸ”´" : "Ğ–Ğ”ĞĞ¢Ğ¬ âšª"

// ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
if bar_index % 1 == 0
    table.cell(liveTable, 0, 0, "Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(liveTable, 1, 0, lastSignal, text_color=color.white, bgcolor=color.gray)

    table.cell(liveTable, 0, 1, "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(liveTable, 1, 1, lastDesc, text_color=color.white,bgcolor=color.gray)

    table.cell(liveTable, 0, 2, "Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(liveTable, 1, 2, recommend_text, text_color=color.white,bgcolor=color.gray)
